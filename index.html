<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Daily Tasks">
  <link rel="manifest" href="/dailytaskapp/manifest.json">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <title>Daily Task App</title>
  <style>
    :root {
      --brand-purple:#845EC2;
      --brand-green:#66B032;
      --accent:#008cba;
      --yellow:#FFD966;
      --text:#222;
      --muted:#666;
      --bg:#f7f7fb;
      --card:#fff;
      --radius:14px;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --border:#e7e7ef;
    }
    html, body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0; padding: 0; height: 100%; width: 100%;
      background: var(--bg);
      color: var(--text);
      box-sizing: border-box; overflow-x: hidden;
    }
    .container { max-width: 980px; margin: 0 auto; padding: 1rem; }

    /* Header */
    header {
      background: var(--yellow);
      padding: 1rem 1.25rem;
      margin: 0 auto 1.25rem auto;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align:center;
    }
    header img { max-width: 80px; display:block; margin: 0 auto; }
    .day-heading { font-size: 1.9rem; font-weight: 800; margin: .5rem 0 .25rem; color: #000; }
    header .weather-content { font-size: 0.95rem; color: #333; }
    header .weather-content .temp { font-size: 1.1rem; font-weight: 700; }
    header .weather-content .desc { font-style: italic; color: #444; }
    #affirmation-box { margin-top: .5rem; font-style: italic; color: var(--muted); opacity: 0; transition: opacity .8s ease; }
    #affirmation-box.visible { opacity: 1; }

    /* Day nav */
    .day-nav {
      display:flex; flex-wrap:wrap; gap:.5rem; justify-content:center;
      margin-bottom: 1.25rem;
    }
    .day-nav a {
      text-decoration:none; color:#fff; background: var(--brand-purple);
      padding:.5rem .8rem; border-radius: 999px; font-weight:700;
      transition: filter .15s ease;
    }

    .section-label { text-align: center; font-size: 1.25rem; color: var(--brand-green); margin: 1.75rem 0 1rem; font-weight: 800; }

    /* Journals & Gratitude */
    .journal-grid { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; }
    section#journals, section#gratitude {
      flex: 1 1 320px; background: var(--card); padding: 1rem;
      border-radius: var(--radius); box-shadow: var(--shadow); border:1px solid var(--border);
      display:flex; flex-direction:column;
    }
    section h2 { margin: 0 0 .6rem; font-size: 1.1rem; font-weight: 800; color: var(--brand-purple); }
    textarea {
      width: 100%; min-height: 100px; padding: 12px; margin-bottom: 1rem;
      font-family: inherit; font-size: 1rem; border-radius: 10px; border: 1px solid #d9d9e3; background: #fff;
    }
    #save-journal-btn { align-self:center; }
    button { padding: 0.6rem 1.1rem; font-size: 1rem; border-radius: 10px; background-color: var(--brand-purple); color: white; border: none; cursor: pointer; font-weight:700; }
    button.secondary { background: var(--accent); }

    /* Mood Picker */
    #mood { display:none; } /* kept for compatibility with main.js */
    .mood-grid { display:flex; flex-wrap:wrap; gap:.5rem; justify-content:center; }
    .mood-chip {
      font-size:1.4rem; padding:.4rem .6rem; border-radius:10px;
      border:1px solid #d9d9e3; background:#fff; cursor:pointer;
      transition:all .15s ease;
    }
    .mood-chip[data-active="true"] { outline:2px solid var(--brand-purple); background:#f0eaff; }
    .mood-live { margin-top:.6rem; text-align:center; color:#555; }

    /* Breathing */
    #breathing .breathing-tile {
      background: var(--card); padding: 1rem; border-radius: var(--radius);
      box-shadow: var(--shadow); border:1px solid var(--border); max-width: 520px; margin: 1.25rem auto;
      text-align:center;
    }
    #breath-bubble { width: 140px; height: 140px; background: radial-gradient(circle, #8fd7ff, var(--accent)); border-radius: 50%; margin: 0 auto .5rem; }
    #breath-text { font-size: 1.2rem; color: var(--accent); font-weight: 800; }
    @keyframes breathe { 0%,100%{transform:scale(1);}50%{transform:scale(1.5);} }
    .breathe-animation { animation: breathe 6s ease-in-out infinite; }

    /* Progress ring card */
    #progress-ring-card { background: var(--card); padding: 1rem; border-radius: var(--radius); box-shadow: var(--shadow); max-width: 520px; margin: 1rem auto; }
    #progress-text { text-align: center; font-weight: 800; color: var(--brand-green); }

    /* Tasks */
    #task-card { background: var(--card); padding: 1rem; border-radius: var(--radius); box-shadow: var(--shadow); border:1px solid var(--border); }
    #task-list {
      display: flex; flex-direction: column; gap: 0.75rem; margin-top: .5rem;
    }
    /* Any direct child becomes a card row (works with various main.js renderings) */
    #task-list > * {
      display: flex; align-items: center; gap: 12px;
      padding: .75rem 1rem; border: 1px solid var(--border); border-radius: 12px;
      background: var(--card); box-shadow: 0 3px 10px rgba(0,0,0,.05);
    }
    #task-list > * label,
    #task-list > * .task-text,
    #task-list > * span { flex:1; font-size:1rem; font-weight:700; color:var(--text); }

    /* Custom checkbox */
    #task-list input[type="checkbox"]{
      inline-size: 20px; block-size: 20px;
      border: 2px solid var(--brand-green); border-radius: 6px;
      appearance: none; display: grid; place-content: center;
      background: #fff; cursor: pointer;
    }
    #task-list input[type="checkbox"]::after{
      content: "✓"; font-weight: 900; transform: scale(0);
      transition: transform .12s ease; color: #fff;
    }
    #task-list input[type="checkbox"]:checked{
      background: var(--brand-green); border-color: var(--brand-green);
    }
    #task-list input[type="checkbox"]:checked::after{ transform: scale(1); }

    /* Completed style */
    #task-list > *.completed { background:#f6fff2; border-color:#d3efc7; opacity:.96; }
    #task-list > *.completed label,
    #task-list > *.completed .task-text,
    #task-list > *.completed span { color:#6a6a6a; text-decoration:line-through; }

    /* Optional delete button if main.js renders one */
    #task-list .task-delete { background:transparent; border:none; font-size:1.1rem; color:#aaa; cursor:pointer; }
    #task-list .task-delete:hover{ color:#d33; }

    /* Footer */
    footer#quote-footer {
      background: var(--card); padding: 1rem; text-align: center; color: var(--muted);
      font-style: italic; font-size: 1rem; margin: 1.5rem 0 0 0; border-radius: var(--radius); border:1px solid var(--border); box-shadow: var(--shadow);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="apple-touch-icon.png" alt="App Logo">
      <h1 id="page-title" class="day-heading"></h1>
      <div id="weather" class="weather-content"></div>
      <div id="affirmation-box"></div>
    </header>

    <div class="day-nav">
      <a href="?day=Monday">Mon</a><a href="?day=Tuesday">Tue</a><a href="?day=Wednesday">Wed</a>
      <a href="?day=Thursday">Thu</a><a href="?day=Friday">Fri</a><a href="?day=Saturday">Sat</a><a href="?day=Sunday">Sun</a>
    </div>

    <h2 class="section-label">🧘 Mindfulness Zone</h2>
    <div class="journal-grid">
      <section id="journals">
        <h2>Journals</h2>
        <textarea id="dream-journal" placeholder="What did you dream about?"></textarea>
        <textarea id="daily-journal" placeholder="Stream your thoughts…"></textarea>
        <button id="save-journal-btn">Save Journals</button>
      </section>

      <section id="gratitude">
        <h2>Gratitude & Mood</h2>
        <textarea id="gratitudeEntry" placeholder="What are you grateful for today?"></textarea>
        <h3>Your Mood</h3>

        <!-- Hidden select for compatibility with main.js -->
        <select id="mood" style="display:none">
          <option value="">How do you feel?</option>
          <option value="😔">Sad</option>
          <option value="😤">Frustrated</option>
          <option value="😐">Neutral</option>
          <option value="🙂">Okay</option>
          <option value="😀">Happy</option>
          <option value="😌">Peaceful</option>
        </select>

        <div class="mood-grid">
          <button class="mood-chip" data-emoji="😔">😔</button>
          <button class="mood-chip" data-emoji="😤">😤</button>
          <button class="mood-chip" data-emoji="😐">😐</button>
          <button class="mood-chip" data-emoji="🙂">🙂</button>
          <button class="mood-chip" data-emoji="😀">😀</button>
          <button class="mood-chip" data-emoji="😌">😌</button>
        </div>
        <div class="mood-live">
          <span id="mood-emoji">—</span>
          <span id="mood-label">How do you feel?</span>
        </div>
      </section>
    </div>

    <section id="breathing">
      <h2 class="section-label">🫁 Breathing Exercise</h2>
      <div class="breathing-tile">
        <div id="breath-bubble"></div>
        <p id="breath-text">Inhale for <span id="countdown">4</span></p>
        <button id="breath-toggle-btn">Start Breath</button>
      </div>
    </section>

    <h2 class="section-label">🌱 Today's Tasks</h2>
    <div id="progress-ring-card">
      <div id="progress-ring-container" style="display:flex;justify-content:center;align-items:center;margin:.5rem auto;">
        <svg id="progress-ring" width="140" height="140" style="transform:rotate(-90deg)">
          <circle id="progress-ring-bg" stroke="#e9e9f2" stroke-width="12" fill="transparent" r="60" cx="70" cy="70"></circle>
          <circle id="progress-ring-bar" stroke="var(--brand-green)" stroke-width="12" fill="transparent" r="60" cx="70" cy="70" stroke-linecap="round" stroke-dasharray="377" stroke-dashoffset="377"></circle>
        </svg>
      </div>
      <p id="progress-text">0% Complete</p>
    </div>

    <div id="task-card">
      <div id="task-list"></div>
      <div class="task-input-group" style="display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;margin-top:1rem;">
        <input type="text" id="new-task" placeholder="Add new task" style="flex:1;min-width:220px;padding:.65rem;border:1px solid #d9d9e3;border-radius:10px;">
        <button onclick="addTask()">Add Task</button>
        <button class="secondary" onclick="resetTasks()">Reset All Tasks</button>
      </div>
    </div>

    <footer id="quote-footer"><p id="quote-box">Loading quote...</p></footer>
  </div>

  <!-- Breathing Toggle -->
  <script>
    (function () {
      const bubble = document.getElementById("breath-bubble");
      const text = document.getElementById("breath-text");
      const button = document.getElementById("breath-toggle-btn");
      let isRunning = false;
      button.addEventListener("click", () => {
        if (!isRunning) {
          isRunning = true;
          bubble.classList.add("breathe-animation");
          text.textContent = "Breathing…";
          button.textContent = "Stop Breath";
        } else {
          isRunning = false;
          bubble.classList.remove("breathe-animation");
          text.textContent = "Paused";
          button.textContent = "Start Breath";
        }
      });
    })();
  </script>

  <!-- Progress ring helper for main.js -->
  <script>
    (function () {
      const r = 60, C = 2*Math.PI*r;
      window.updateProgressCircle = function (percent) {
        const pct = Math.max(0, Math.min(100, Number(percent)||0));
        const circle = document.getElementById('progress-ring-bar');
        if (!circle) return;
        circle.style.strokeDashoffset = (C - (pct/100)*C);
        const label = document.getElementById('progress-text');
        if (label) label.textContent = `${pct}% Complete`;
      };
    })();
  </script>

  <!-- Mood chips -> hidden select sync -->
  <script>
    (function () {
      const select = document.getElementById('mood');
      const chips = Array.from(document.querySelectorAll('.mood-chip'));
      const liveEmoji = document.getElementById('mood-emoji');
      const liveLabel = document.getElementById('mood-label');
      function selectMood(emoji){
        chips.forEach(c=>c.setAttribute('data-active', c.dataset.emoji===emoji ? 'true' : 'false'));
        if (select) select.value = emoji || '';
        liveEmoji.textContent = emoji || '—';
        liveLabel.textContent = emoji ? 'Mood selected' : 'How do you feel?';
      }
      chips.forEach(c=>c.addEventListener('click', ()=>selectMood(c.dataset.emoji)));
      selectMood(''); // start blank
    })();
  </script>

  <!-- Task chime + completed visuals -->
  <script>
    (function () {
      const list = document.getElementById('task-list');

      function playCompleteChime() {
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const now = ctx.currentTime;
          const gain = ctx.createGain();
          gain.gain.value = 0.15;
          gain.connect(ctx.destination);
          const tones = [880, 1318.5]; // A5 -> E6
          tones.forEach((f, i) => {
            const o = ctx.createOscillator();
            o.type = 'sine';
            o.frequency.value = f;
            o.connect(gain);
            o.start(now + i*0.06);
            o.stop(now + i*0.06 + 0.35);
          });
          gain.gain.exponentialRampToValueAtTime(0.001, now + 0.6);
        } catch(e) {}
      }

      // Delegate checkbox changes from whatever markup main.js renders
      list.addEventListener('change', (e) => {
        const cb = e.target;
        if (cb && cb.matches('input[type="checkbox"]')) {
          const row = cb.closest('#task-list > *') || cb.parentElement;
          if (row) row.classList.toggle('completed', cb.checked);
          if (cb.checked) playCompleteChime();
        }
      });

      // Hydrate any pre-checked tasks after main.js renders
      setTimeout(() => {
        list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          const row = cb.closest('#task-list > *') || cb.parentElement;
          if (row) row.classList.toggle('completed', cb.checked);
        });
      }, 0);
    })();
  </script>

  <!-- Header updater: date/time, weather, affirmation, quote -->
  <script>
    (function () {
      const $ = (id) => document.getElementById(id);
      const weatherEl = $("weather");
      const titleEl = $("page-title");
      const quoteEl = $("quote-box");
      const affirmationEl = $("affirmation-box");

      // Date/Time
      function renderNow() {
        const d = new Date();
        const day = d.toLocaleDateString(undefined, { weekday: "long" });
        const date = d.toLocaleDateString(undefined, { month: "long", day: "numeric", year: "numeric" });
        const time = d.toLocaleTimeString(undefined, { hour: "numeric", minute: "2-digit" });
        if (titleEl) titleEl.textContent = `${day} • ${date} • ${time}`;
      }
      renderNow();
      setInterval(renderNow, 60 * 1000);

      // Affirmation
      const AFFIRMATIONS = [
        "You’re doing better than you think.",
        "One small step counts today.",
        "You can handle this moment.",
        "Breathe in calm, breathe out doubt.",
        "Progress, not perfection.",
        "Your effort matters."
      ];
      (function showAffirmation(){
        const a = AFFIRMATIONS[Math.floor(Math.random() * AFFIRMATIONS.length)];
        if (affirmationEl) { affirmationEl.textContent = a; affirmationEl.classList.add("visible"); }
      })();

      // Quote
      async function loadQuote() {
        try {
          const r = await fetch("https://api.quotable.io/random?minLength=60&maxLength=160", { cache: "no-store" });
          if (!r.ok) throw new Error("quote fail");
          const q = await r.json();
          if (quoteEl) quoteEl.textContent = `“${q.content}” — ${q.author}`;
        } catch {
          if (quoteEl) quoteEl.textContent = "“Be kind to yourself — you’re learning as you go.”";
        }
      }
      loadQuote();

      // Weather (Open-Meteo)
      const WMAP = {
        0:"Clear sky",1:"Mainly clear",2:"Partly cloudy",3:"Overcast",
        45:"Fog",48:"Rime fog",51:"Light drizzle",53:"Drizzle",55:"Heavy drizzle",
        61:"Light rain",63:"Rain",65:"Heavy rain",66:"Freezing rain",67:"Heavy freezing rain",
        71:"Light snow",73:"Snow",75:"Heavy snow",77:"Snow grains",
        80:"Rain showers",81:"Heavy rain showers",82:"Violent rain showers",
        85:"Snow showers",86:"Heavy snow showers",
        95:"Thunderstorm",96:"Thunderstorm w/ hail",99:"Thunderstorm w/ heavy hail"
      };
      function renderWeather({ temp, desc }) {
        if (!weatherEl) return;
        weatherEl.innerHTML = `<div class="temp">${Math.round(temp)}°</div><div class="desc">${desc}</div>`;
      }
      async function getWeather(lat, lon) {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto`;
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error("weather fail");
        const j = await r.json();
        const cur = j.current || j.current_weather || {};
        const temp = cur.temperature_2m ?? cur.temperature;
        const code = cur.weather_code ?? cur.weathercode;
        renderWeather({ temp, desc: WMAP[code] || "Weather" });
      }
      function weatherFallback() {
        const guesses = [
          { lat: 40.7128, lon: -74.0060 }, // NYC
          { lat: 34.0522, lon: -118.2437 }, // LA
          { lat: 41.8781, lon: -87.6298 }, // Chicago
        ];
        const pick = guesses[Math.floor(Math.random() * guesses.length)];
        getWeather(pick.lat, pick.lon).catch(() => {
          if (weatherEl) weatherEl.innerHTML = `<div class="desc">Weather unavailable</div>`;
        });
      }
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => getWeather(pos.coords.latitude, pos.coords.longitude).catch(weatherFallback),
          weatherFallback,
          { enableHighAccuracy: false, maximumAge: 30 * 60_000, timeout: 6000 }
        );
      } else {
        weatherFallback();
      }
    })();
  </script>

  <!-- Your app logic that manages tasks/journals/etc. -->
  <script type="module" src="main.js"></script>
</body>
</html>